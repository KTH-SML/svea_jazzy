<?xml version="1.0"?>
<launch>

    <!-- Arguments BEGIN -->

    <arg name="name"            default="self"/>
    <arg name="is_sim"          default="true"/>
    <arg name="is_indoor"       default="true"/>
    <arg name="initial_pose_x"  default="0.0"/>
    <arg name="initial_pose_y"  default="0.0"/>
    <arg name="initial_pose_a"  default="0.0"/> <!-- Yaw Angle -->

    <arg name="use_zenoh"       default="false"/>

    <arg name="use_urdf"        default="$(var is_sim)"/>

    <arg name="map"             default="floor2"/>
    <arg name="map_file"        default="$(find-pkg-share svea_core)/maps/$(var map).yaml"/>

    <!-- Arguments END -->

    <!-- If-Else Group -->
    <group if="$(var is_sim)">
        <!-- Simulation -->
        <include file="$(find-pkg-share svea_core)/launch/simulation.xml">
            <arg name="name"    value="$(var name)"/>
            <arg name="map"     value="$(var map)" />
            <arg name="initial_pose_x" value="$(var initial_pose_x)" />
            <arg name="initial_pose_y" value="$(var initial_pose_y)" />
            <arg name="initial_pose_a" value="$(var initial_pose_a)" />
        </include>
    </group>
    <group unless="$(var is_sim)">
        <!-- Low-Level Interface -->
        <executable cmd="$(find-pkg-share svea_core)/util/start_micro_ros.sh" output="screen"/>

        <!--LLI Fixers-->
        <node pkg="svea_core" exec="encoder_filter.py" name="encoder_filter" output="screen"/>
        <node pkg="svea_core" exec="imu_bias_remover.py" name="imu_bias_remover" output="screen"/>
        <node pkg="svea_core" exec="lidar_timer.py" name="lidar_timer" output="screen"/>
    </group>

    <!-- Localization -->
    <include file="$(find-pkg-share svea_localization)/launch/localization.xml">
        <arg name="name"           value="$(var name)"/>
        <arg name="is_sim"         value="$(var is_sim)"/>
        <arg name="is_indoor"      value="$(var is_indoor)"/>
        <arg name="initial_pose_x" value="$(var initial_pose_x)" />
        <arg name="initial_pose_y" value="$(var initial_pose_y)" />
        <arg name="initial_pose_a" value="$(var initial_pose_a)" />
    </include>

    <!-- Load Visualization Model -->
    <include if="$(var use_urdf)" file="$(find-pkg-share svea_core)/launch/visualization.xml">
        <arg name="name" value="$(var name)"/>
    </include>

    <!-- Zenoh -->
    <let name="zenoh_cmd" value="zenoh-bridge-ros2dds -c $(find-pkg-share svea_core)/params/zenoh.json5 --ros-args"/>
    <let name="zenoh_cmd" value="$(var zenoh_cmd) --remap /fleet/$(var name)/state:=/$(var name)/odometry/local"/>
    <!-- <executable if="$(var use_zenoh)" cmd="$(var zenoh_cmd)" output="screen"/> -->
    <let name="zenoh_config" value="$(find-pkg-share svea_core)/params/zenoh.json5"/>
    <executable if="$(var use_zenoh)" cmd="zenoh-bridge-ros2dds -c $(var zenoh_config)" output="screen"/>

</launch>
