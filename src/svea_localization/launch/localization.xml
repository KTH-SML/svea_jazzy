<?xml version="1.0"?>
<launch>
    <!-- Arguments BEGIN -->

    <arg name="name"                    default="self"/>
    <arg name="is_sim"                  default="true"/>
    <arg name="is_indoor"               default="true"/>
    <arg name="initial_pose_x"          default="0.0"/>
    <arg name="initial_pose_y"          default="0.0"/>
    <arg name="initial_pose_a"          default="0.0"/>

    <!-- When indoors, map_file is required -->
    <group if="$(var is_indoor)">
        <arg name="map_file"/>
    </group>

    <!-- Frames -->
    <arg name="map_frame"   default="map"/>
    <arg name="odom_frame"  default="$(var name)/odom"/>
    <arg name="base_frame"  default="$(var name)/base_link"/>

    <!-- Lidar -->
    <arg name="lidar_ip" default=""/>

    <!-- Arguments END -->

    <group>

        <push-ros-namespace namespace="$(var name)"/>

        <!-- Static transforms for sensors -->
        <include file="$(find-pkg-share svea_localization)/launch/transforms.xml">
            <arg name="is_indoor"  value="$(var is_indoor)"/>
            <arg name="map_frame"  value="$(var map_frame)"/>
            <arg name="odom_frame" value="$(var odom_frame)"/>
            <arg name="base_frame" value="$(var base_frame)"/>
        </include>

        <!-- If-Else Group -->
        <group if="$(var is_sim)">
            <!-- No simulation-specific launches yet -->
        </group>
        <group unless="$(var is_sim)">
            <let name="use_sim_time" value="false"/>

            <!-- Robot localization (Local EKF)-->
            <node pkg="robot_localization" exec="ekf_node" name="ekf_local" output="screen">
                <param from="$(find-pkg-share svea_localization)/params/local_ekf.yaml" />
                <param name="map_frame"             value="$(var map_frame)"/>
                <param name="odom_frame"            value="$(var odom_frame)"/>
                <param name="base_link_frame"       value="$(var base_frame)"/>
                <param name="world_frame"           value="$(var odom_frame)"/>
                <param name="imu0"                  value="/lli/filtered/imu"/>
                <param name="twist0"                value="/lli/filtered/encoder"/>
                <remap from="/odometry/filtered"    to="$(var name)/odometry/local"/>
            </node>

            <!-- If-Else Group -->
            <group if="$(var is_indoor)">
                <!-- Start LiDAR -->
                <include file="$(find-pkg-share svea_localization)/launch/lidar.xml">
                    <arg name="lidar_ip"    value="$(var lidar_ip)"/>
                    <arg name="lidar_frame" value="$(var name)/laser"/>
                </include>

                <!-- Start AMCL -->
                <node pkg="nav2_amcl" exec="amcl" name="amcl" output="screen">
                    <param from="$(find-pkg-share svea_localization)/params/localize.yaml"/>
                    <param name="use_sim_time"      value="$(var use_sim_time)"/>
                    <param name="yaml_filename"     value="$(var map_file)"/>
                    <param name="scan"              value="$(var name)/scan"/>
                    <param name="initial_pose.x"    value="$(var initial_pose_x)"/>
                    <param name="initial_pose.y"    value="$(var initial_pose_y)"/>
                    <param name="initial_pose.yaw"  value="$(var initial_pose_a)"/>
                    <param name="base_frame_id"     value="$(var base_frame)"/>
                    <param name="odom_frame_id"     value="$(var odom_frame)"/>
                    <param name="map_frame_id"      value="$(var map_frame)"/>
                    <param name="map_topic"         value="/map"/>
                </node>
                <node pkg="nav2_lifecycle_manager" exec="lifecycle_manager" name="lifecycle_manager_amcl" output="screen">
                    <param name="use_sim_time" value="$(var use_sim_time)"/>
                    <param name="autostart"    value="true"/>
                    <param name="node_names"   value="['amcl']"/>
                </node>
            </group>
            <group unless="$(var is_indoor)">
                <!-- TODO: Outdoor localization -->
                
                <!-- <group if="$(var start_rtk)"> -->
                    <!-- <include file="$(find-pkg-share svea_localization)/launch/rtk.xml"> -->
                        <!-- <arg name="gps_device"      value="$(var gps_device)" /> -->
                        <!-- <arg name="baud"            value="$(var gps_baud)" /> -->
                    <!-- </include> -->
                <!-- </group> -->
                <!-- <include file="$(find-pkg-share svea_localization)/launch/navsat.xml"> -->
                    <!-- <arg name="delay"           value="$(var delay)"/> -->
                    <!-- <arg name="yaw_offset"      value="$(var initial_pose_a)"/> -->
                    <!-- <arg name="use_datum"       value="$(var use_datum)" /> -->
                    <!-- <arg name="datum_service"   value="$(var datum_service)" /> -->
                    <!-- <arg name="datum_file"      value="$(var datum_file)" /> -->
                    <!-- <arg name="datum_data"      value="$(var datum_data)" /> -->
                <!-- </include> -->

                <!-- Global EKF -->
                <node unless="$(var is_indoor)" pkg="robot_localization" exec="ekf_node" name="ekf_global" output="screen">
                    <param from="$(find-pkg-share svea_localization)/params/global_ekf.yaml"/>
                    <param name="initial_state[0]" value="$(var initial_pose_x)"/>
                    <param name="initial_state[1]" value="$(var initial_pose_y)"/>
                    <param name="initial_state[5]" value="$(var initial_pose_a)"/>
                    <param name="imu0"             value="/lli/sensor/imu"/>
                    <param name="twist0"           value="/lli/sensor/encoders"/>
                    <param name="odom0"            value="$(var name)/odometry/gps"/>
                    <remap from="/odometry/filtered" to="$(var name)/odometry/global"/>
                    <!-- TODO: <remap from="/set_pose"             to="/global/set_pose"/> -->
                </node>
            </group>
        </group>

    </group>

</launch>
